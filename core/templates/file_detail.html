{% extends "base.html" %}
{% load static %}

{% block title %}{{ file.filename }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
  <div class="lg:col-span-2 space-y-4">
    <div class="bg-white p-4 rounded-lg shadow">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h2 class="text-2xl font-bold">{{ file.filename }}</h2>
          <p class="text-sm text-gray-500 mt-1">Uploaded by <span class="font-medium text-slate-700">{{ file.owner.username }}</span> ‚Ä¢ {{ file.uploaded_at|date:"Y-m-d H:i" }}</p>
        </div>

        <div class="flex flex-col items-end gap-2">
          <div class="flex items-center gap-2">
            <span class="text-xs uppercase tracking-wide px-2 py-1 rounded-full {% if file.status == FileStatus.APPROVED %}bg-green-50 text-green-700{% elif file.status == FileStatus.IN_REVIEW %}bg-blue-50 text-blue-700{% elif file.status == FileStatus.REJECTED %}bg-red-50 text-red-700{% else %}bg-yellow-50 text-yellow-700{% endif %}">
              {{ file.get_status_display }}
            </span>
            <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">Version {{ file.version_label }}</span>
          </div>
          <div class="flex items-center gap-2">
            {% if can_download_original %}
              <a href="{% url 'download_original' file.id %}" class="text-sm px-3 py-2 bg-slate-50 rounded-md hover:bg-slate-100">Download Original</a>
            {% endif %}

            {% if user.is_authenticated and user == file.owner %}
              <a href="{% url 'file_edit' file.id %}" class="text-sm px-3 py-2 bg-indigo-50 text-indigo-700 rounded-md hover:bg-indigo-100">Edit</a>
              <form method="post" action="{% url 'file_delete' file.id %}" class="inline-block" onsubmit="return confirm('Are you sure you want to delete this file?');">
                {% csrf_token %}
                <button type="submit" class="text-sm px-3 py-2 bg-red-50 text-red-700 rounded-md hover:bg-red-100">Delete</button>
              </form>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% if file.converted %}
    <div class="bg-white p-4 rounded-lg shadow">
      <div class="flex items-center justify-between mb-3">
        <h3 class="font-semibold">PDF Preview</h3>
        <div class="flex items-center gap-2">
          <a href="{% url 'download_pdf' file.id %}" class="text-sm px-3 py-1 bg-red-50 text-red-700 rounded-md hover:bg-red-100">Download PDF</a>
          <!-- Open the raw PDF in a new tab using the browser's built‚Äëin viewer -->
          <a
            href="{% url 'view_pdf' file.id %}"
            target="_blank"
            class="text-sm px-3 py-1 bg-green-50 text-green-700 rounded-md hover:bg-green-100"
          >
            Open in New Tab
          </a>
        </div>
      </div>

      <div class="border rounded overflow-hidden bg-gray-100">
        <!-- Use browser's built‚Äëin PDF viewer instead of PDF.js to avoid 204 issues -->
        <object
          data="{% url 'view_pdf' file.id %}"
          type="application/pdf"
          width="100%"
          height="720">
          <p>Your browser doesn't support inline PDF viewing.
             <a href="{% url 'download_pdf' file.id %}">Download the PDF</a> instead.</p>
        </object>
      </div>
      
      <p class="text-xs text-gray-500 mt-2">
        üìÑ Viewing: {{ file.file_name_if_converted }}
      </p>
    </div>
    {% else %}
      <div class="bg-yellow-50 border-l-4 border-yellow-300 p-4 rounded">
        <p class="text-sm text-yellow-800">
          ‚ö†Ô∏è PDF not generated yet. 
          {% if user.is_authenticated and user == file.owner %}
            <a href="{% url 'convert_to_pdf' file.id %}" class="font-medium underline hover:text-yellow-900">Click here to convert to PDF</a>
          {% else %}
            Ask the owner to convert this file to PDF.
          {% endif %}
        </p>
      </div>
    {% endif %}

    <div class="bg-white p-4 rounded-lg shadow">
      <h3 class="font-semibold mb-3">Version History</h3>
      <div class="space-y-3 max-h-96 overflow-y-auto">
        {% for version in versions %}
          <div class="border rounded-md p-3 bg-slate-50">
            <div class="flex items-center justify-between text-xs text-gray-500 flex-wrap gap-2">
              <span class="font-semibold text-slate-700">v{{ version.version_label }} ‚Ä¢ {{ version.get_change_type_display }}</span>
              <span>{{ version.created_at|date:"Y-m-d H:i" }}</span>
            </div>
            <p class="text-sm text-gray-800 mt-2">
              {% if version.comment %}{{ version.comment }}{% else %}<span class="text-gray-400">No comment provided.</span>{% endif %}
            </p>
            <p class="text-xs text-gray-500 mt-1">By {{ version.created_by.username|default:"system" }}</p>
          </div>
        {% empty %}
          <p class="text-sm text-gray-500">No version history yet.</p>
        {% endfor %}
      </div>
    </div>
  </div>

  <aside class="space-y-4">
    <div class="bg-white p-4 rounded-lg shadow">
      <h4 class="font-semibold mb-2">File Info</h4>
      <dl class="text-sm text-gray-600 space-y-2">
        <div><dt class="font-medium text-gray-800">Filename</dt><dd class="break-all">{{ file.filename }}</dd></div>
        <div><dt class="font-medium text-gray-800">Uploaded</dt><dd>{{ file.uploaded_at|date:"Y-m-d H:i" }}</dd></div>
        <div><dt class="font-medium text-gray-800">Owner</dt><dd>{{ file.owner.username }}</dd></div>
        <div><dt class="font-medium text-gray-800">Current Version</dt><dd>v{{ file.version_label }}</dd></div>
        <div><dt class="font-medium text-gray-800">Status</dt><dd>{{ file.get_status_display }}</dd></div>
        {% if file.reviewed_by %}
        <div><dt class="font-medium text-gray-800">Last Reviewed</dt><dd>{{ file.reviewed_by.username }} ‚Ä¢ {{ file.reviewed_at|date:"Y-m-d H:i" }}</dd></div>
        {% endif %}
        {% if file.converted %}
        <div><dt class="font-medium text-gray-800">PDF Status</dt><dd class="text-green-600 font-medium">‚úì Converted</dd></div>
        <div><dt class="font-medium text-gray-800">PDF Name</dt><dd class="break-all text-xs">{{ file.file_name_if_converted }}</dd></div>
        {% else %}
        <div><dt class="font-medium text-gray-800">PDF Status</dt><dd class="text-yellow-600">‚ö† Not converted</dd></div>
        {% endif %}
      </dl>
    </div>

    {% if can_review %}
    <div class="bg-white p-4 rounded-lg shadow space-y-3">
      <h4 class="font-semibold">Review Actions</h4>
      <div class="flex flex-col gap-2">
        <form method="post" action="{% url 'update_file_status' file.id 'start' %}">
          {% csrf_token %}
          <button class="w-full px-3 py-2 rounded-md text-sm bg-blue-50 text-blue-700 hover:bg-blue-100">Mark In Review</button>
        </form>
        <form method="post" action="{% url 'update_file_status' file.id 'approve' %}">
          {% csrf_token %}
          <button class="w-full px-3 py-2 rounded-md text-sm bg-green-600 text-white hover:bg-green-700">Approve</button>
        </form>
        <form method="post" action="{% url 'update_file_status' file.id 'reject' %}">
          {% csrf_token %}
          <button class="w-full px-3 py-2 rounded-md text-sm bg-red-50 text-red-700 hover:bg-red-100">Reject</button>
        </form>
      </div>
    </div>
    {% endif %}

    <div class="bg-white p-4 rounded-lg shadow">
      <h4 class="font-semibold mb-3">Comments ({{ comments|length }})</h4>

      <div class="space-y-2 max-h-96 overflow-y-auto">
        {% for comment in comments %}
          <div class="bg-gray-50 p-3 rounded-md border border-gray-200">
            <p class="text-sm text-gray-800">{{ comment.text }}</p>
            <div class="text-xs text-gray-500 mt-2">
              <span class="font-medium">{{ comment.user.username|default:"Anonymous" }}</span> ‚Ä¢ 
              {{ comment.created_at|date:"M d, Y H:i" }}
            </div>
          </div>
        {% empty %}
          <div class="text-sm text-gray-500 text-center py-4">
            üí¨ No comments yet.
          </div>
        {% endfor %}
      </div>

      <div class="mt-4 pt-4 border-t">
        {% if user.is_authenticated and user == file.owner %}
          <form method="post" action="{% url 'add_comment' file.id %}" class="space-y-3">
            {% csrf_token %}
            <label class="block text-sm">
              <span class="text-gray-700 font-medium">Add a comment</span>
              <textarea 
                name="text" 
                rows="3" 
                required 
                class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2 border" 
                placeholder="Write your comment here...">{{ request.POST.text }}</textarea>
            </label>
            <div class="flex items-center gap-2">
              <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium transition">
                üí¨ Add Comment
              </button>
            </div>
          </form>
        {% elif user.is_authenticated %}
          <p class="text-sm text-gray-500">üîí Only the owner can add comments.</p>
        {% else %}
          <p class="text-sm text-gray-500">üîí <a href="{% url 'admin:login' %}" class="text-indigo-600 hover:underline">Login</a> to comment.</p>
        {% endif %}
      </div>
    </div>
    
    <div class="text-center">
      <a href="{% url 'file_list' %}" class="inline-block text-sm text-indigo-600 hover:underline">
        ‚Üê Back to all files
      </a>
    </div>
  </aside>
</div>
{% endblock %}