{% extends "base.html" %}
{% load static %}

{% block title %}Edit {{ file.filename }}{% endblock %}

{% block content %}

<div class="max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8">
  <div class="lg:col-span-2 space-y-4">
    <div class="bg-white p-4 rounded-lg shadow">
      <div class="flex items-center justify-between gap-3 mb-4">
        <div>
          <h1 class="text-2xl font-bold">Editing: {{ file.filename }}</h1>
          <p class="text-xs text-gray-500 mt-1">
            Uploaded: {{ file.uploaded_at|date:"Y-m-d H:i" }} ‚Ä¢ Owner: {{ file.owner.username|default:"Unknown" }}
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2 text-xs">
          <span class="px-2 py-1 rounded-full bg-slate-100 text-slate-700 uppercase tracking-wide">
            {{ extension|default:"unknown" }}
          </span>
        </div>
      </div>

      {% if editable_text %}
        <h2 class="text-sm font-semibold mb-2">Inline editor (text-based file)</h2>
        <form method="post" class="space-y-3">
          {% csrf_token %}
          <textarea
            name="edited_text"
            rows="18"
            class="w-full rounded-md border border-gray-300 font-mono text-sm p-3 bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          >{{ editable_text }}</textarea>

          <div class="space-y-3">
            <div>
              <span class="text-xs font-semibold text-gray-700">Version change</span>
              <div class="mt-1 flex flex-wrap gap-4 text-xs text-gray-700">
                <label class="flex items-center gap-1">
                  <input type="radio" name="change_type" value="{{ ChangeTypes.MINOR }}" checked>
                  Minor (+0.1)
                </label>
                <label class="flex items-center gap-1">
                  <input type="radio" name="change_type" value="{{ ChangeTypes.MAJOR }}">
                  Major (+1.0)
                </label>
              </div>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">
                Optional note about this edit
              </label>
              <textarea
                name="edit_comment"
                rows="2"
                class="w-full rounded-md border border-gray-200 text-xs p-2 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
                placeholder="Describe what you changed... (stored with the version history)"
              ></textarea>
            </div>
            <button
              type="submit"
              class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700"
            >
              üíæ Save changes
            </button>
          </div>
        </form>

      {% elif image_preview %}
        <h2 class="text-sm font-semibold mb-2">Image preview</h2>
        <img
          src="{{ file.file.url }}"
          alt="Image preview"
          class="w-full max-h-[640px] object-contain rounded border border-gray-200 bg-gray-50"
        />

      {% elif pdf_preview %}
        <h2 class="text-sm font-semibold mb-2">PDF preview</h2>
        <object
          data="{% url 'view_pdf' file.id %}"
          type="application/pdf"
          width="100%"
          height="720"
          class="border border-gray-200 rounded bg-gray-50"
        >
          <p class="text-sm text-gray-600 p-3">
            Inline PDF viewing is not supported in this browser.
            <a href="{% url 'download_pdf' file.id %}" class="text-indigo-600 underline">
              Download the PDF
            </a>
            instead.
          </p>
        </object>

      {% elif text_preview %}
        <h2 class="text-sm font-semibold mb-2">Preview</h2>
        <pre class="w-full rounded-md border border-gray-200 bg-gray-50 p-3 text-xs whitespace-pre-wrap overflow-auto max-h-[640px]">{{ text_preview }}</pre>

      {% else %}
        <p class="text-sm text-gray-600">
          Inline editing is only available for plain text files.
          For Word, Excel, and other binary formats, please edit the file on your computer
          and use the form on the right to upload a new version.
        </p>
        <p class="mt-2 text-sm">
          Current file:
          <a href="{{ file.file.url }}" class="text-indigo-600 underline break-all">
            {{ file.filename }}
          </a>
        </p>
      {% endif %}
    </div>

    <div>
      <a href="{% url 'file_detail' file.id %}" class="text-sm text-indigo-600 hover:underline">
        ‚Üê Back to file details
      </a>
    </div>
  </div>

  <aside class="space-y-4">
    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-sm font-semibold mb-3">Replace file</h2>
      <p class="text-xs text-gray-500 mb-3">
        Upload a new version (DOCX, XLSX, PDF, images, etc.). The original will be replaced,
        and any converted PDF will be cleared automatically.
      </p>
      <form method="post" enctype="multipart/form-data" class="space-y-4">
        {% csrf_token %}
        {{ form.file }}
        <div>
          <span class="text-xs font-semibold text-gray-700">Version change</span>
          <div class="mt-1 flex flex-wrap gap-4 text-xs text-gray-700">
            <label class="flex items-center gap-1">
              <input type="radio" name="change_type" value="{{ ChangeTypes.MINOR }}" checked>
              Minor (+0.1)
            </label>
            <label class="flex items-center gap-1">
              <input type="radio" name="change_type" value="{{ ChangeTypes.MAJOR }}">
              Major (+1.0)
            </label>
          </div>
        </div>
        <div>
          <label class="block text-xs font-medium text-gray-700 mb-1">Notes about this upload</label>
          <textarea
            name="edit_comment"
            rows="2"
            class="w-full rounded-md border border-gray-200 text-xs p-2 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500"
            placeholder="Explain what changed so reviewers have context"></textarea>
        </div>
        <button
          type="submit"
          class="w-full inline-flex items-center justify-center px-4 py-2 bg-slate-800 text-white text-sm font-medium rounded-md hover:bg-slate-900"
        >
          ‚¨ÜÔ∏è Upload new version
        </button>
      </form>
    </div>

    <div class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-sm font-semibold mb-3">Add comment about this file</h2>
      <form method="post" action="{% url 'add_comment' file.id %}" class="space-y-3">
        {% csrf_token %}
        <textarea
          name="text"
          rows="3"
          required
          class="w-full rounded-md border border-gray-300 shadow-sm text-sm p-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
          placeholder="Write a comment about the current version or edits you plan to make..."
        ></textarea>
        <button
          type="submit"
          class="w-full inline-flex items-center justify-center px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-md hover:bg-indigo-700"
        >
          üí¨ Save comment
        </button>
      </form>
    </div>
  </aside>
</div>

{% endblock %}
